{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "chat",
  "type": "registry:component",
  "title": "Chat",
  "description": "A composable chat component",
  "dependencies": [
    "debounce",
    "react-use-measure"
  ],
  "registryDependencies": [
    "input-group",
    "avatar"
  ],
  "files": [
    {
      "path": "registry/joyco/blocks/chat.tsx",
      "content": "'use client'\n\nimport * as React from 'react'\nimport { ArrowUpIcon } from 'lucide-react'\nimport debounce from 'debounce'\nimport useMeasure from 'react-use-measure'\n\nimport { cn } from '@/lib/utils'\nimport {\n  InputGroup,\n  InputGroupAddon,\n  InputGroupButton,\n  InputGroupInput,\n  InputGroupTextarea,\n} from '@/components/ui/input-group'\nimport { Avatar, AvatarImage, AvatarFallback } from '@/components/ui/avatar'\nimport { useUserInterruption } from '@/hooks/use-interruption'\nimport { useComposedRefs } from '@/lib/compose-refs'\n\ntype ChatMessageVariant = 'self' | 'peer' | 'system'\n\n/* -------------------------------------------------------------------------------------------------\n * ChatSubmitEvent\n * -------------------------------------------------------------------------------------------------*/\n\nexport class ChatSubmitEvent {\n  readonly form: HTMLFormElement\n  readonly input: HTMLInputElement | HTMLTextAreaElement | null\n  readonly message: string\n  defaultPrevented = false\n\n  constructor(data: {\n    form: HTMLFormElement\n    input: HTMLInputElement | HTMLTextAreaElement | null\n    message: string\n  }) {\n    this.form = data.form\n    this.input = data.input\n    this.message = data.message\n  }\n\n  preventDefault() {\n    this.defaultPrevented = true\n  }\n}\n\n/* -------------------------------------------------------------------------------------------------\n * Chat Context\n * -------------------------------------------------------------------------------------------------*/\n\ntype ChatContextValue = {\n  inputRef: React.RefObject<HTMLInputElement | HTMLTextAreaElement | null>\n  viewportRef: React.RefObject<HTMLDivElement | null>\n  scrollToBottom: (behavior?: ScrollBehavior) => void\n  onSubmit?: (event: ChatSubmitEvent) => void\n  onViewportHeightChange: (height: number) => void\n  onInputHeightChange: (height: number) => void\n}\n\nconst ChatContext = React.createContext<ChatContextValue | null>(null)\n\nfunction useChatContext() {\n  const context = React.useContext(ChatContext)\n  if (!context) {\n    throw new Error('Chat components must be used within a <Chat /> component')\n  }\n  return context\n}\n\n/* -------------------------------------------------------------------------------------------------\n * Chat\n * -------------------------------------------------------------------------------------------------*/\n\ntype ChatProps = {\n  onSubmit?: (event: ChatSubmitEvent) => void\n  bottomThreshold?: number\n  children: React.ReactNode\n}\n\nexport function Chat({ onSubmit, bottomThreshold = 24, children }: ChatProps) {\n  const [isAtBottom, setIsAtBottom] = React.useState(true)\n  const { interruptedRef, interrupt } = useUserInterruption(200)\n  const viewportRef = React.useRef<HTMLDivElement>(null)\n  const inputRef = React.useRef<HTMLInputElement | HTMLTextAreaElement>(null)\n\n  const isAtBottomRef = React.useRef(true)\n  const isScrollingToBottomRef = React.useRef(false)\n  const prevViewportHeightRef = React.useRef(0)\n  const prevInputHeightRef = React.useRef(0)\n\n  React.useEffect(() => {\n    isAtBottomRef.current = isAtBottom\n  }, [isAtBottom])\n\n  const scrollToBottom = React.useCallback(\n    (behavior: ScrollBehavior = 'smooth') => {\n      const viewport = viewportRef.current\n\n      if (!viewport || interruptedRef.current) return\n\n      isScrollingToBottomRef.current = true\n\n      viewport.scrollTo({ top: viewport.scrollHeight, behavior })\n    },\n    [interruptedRef]\n  )\n\n  const checkIfAtBottom = React.useCallback(() => {\n    const viewport = viewportRef.current\n    if (!viewport) return false\n\n    const { scrollTop, scrollHeight, clientHeight } = viewport\n    const distanceFromBottom = scrollHeight - scrollTop - clientHeight\n    return distanceFromBottom <= bottomThreshold\n  }, [bottomThreshold])\n\n  React.useEffect(() => {\n    const viewport = viewportRef.current\n    if (!viewport) return\n\n    const handleScroll = debounce(() => {\n      const actuallyAtBottom = checkIfAtBottom()\n\n      if (isScrollingToBottomRef.current) {\n        if (actuallyAtBottom) {\n          isScrollingToBottomRef.current = false\n        }\n        setIsAtBottom(true)\n        return\n      }\n\n      setIsAtBottom(actuallyAtBottom)\n    }, 100)\n\n    const handleUserInterrupt = () => {\n      if (isScrollingToBottomRef.current) {\n        isScrollingToBottomRef.current = false\n        setIsAtBottom(checkIfAtBottom())\n      }\n      interrupt()\n    }\n\n    viewport.addEventListener('scroll', handleScroll)\n    viewport.addEventListener('wheel', handleUserInterrupt, { passive: true })\n    viewport.addEventListener('touchstart', handleUserInterrupt, {\n      passive: true,\n    })\n\n    return () => {\n      viewport.removeEventListener('scroll', handleScroll)\n      viewport.removeEventListener('wheel', handleUserInterrupt)\n      viewport.removeEventListener('touchstart', handleUserInterrupt)\n    }\n  }, [bottomThreshold, interrupt, checkIfAtBottom])\n\n  const onViewportHeightChange = React.useCallback(\n    (height: number) => {\n      if (!isAtBottomRef.current) return\n\n      const viewportHeightChange = height - prevViewportHeightRef.current\n\n      if (viewportHeightChange > 0) {\n        scrollToBottom()\n      }\n\n      prevViewportHeightRef.current = height\n    },\n    [scrollToBottom]\n  )\n\n  const onInputHeightChange = React.useCallback(\n    (height: number) => {\n      if (!isAtBottomRef.current) return\n\n      const inputHeightChange = height - prevInputHeightRef.current\n\n      if (inputHeightChange > 0) {\n        scrollToBottom()\n      }\n\n      prevInputHeightRef.current = height\n    },\n    [scrollToBottom]\n  )\n\n  const contextValue = React.useMemo<ChatContextValue>(\n    () => ({\n      viewportRef,\n      inputRef,\n      scrollToBottom,\n      onSubmit,\n      onViewportHeightChange,\n      onInputHeightChange,\n    }),\n    [scrollToBottom, onSubmit, onViewportHeightChange, onInputHeightChange]\n  )\n\n  return (\n    <ChatContext.Provider value={contextValue}>{children}</ChatContext.Provider>\n  )\n}\n\nexport { useChatContext }\n\n/* -------------------------------------------------------------------------------------------------\n * ChatViewport\n * -------------------------------------------------------------------------------------------------*/\n\nexport function ChatViewport({\n  className,\n  ...props\n}: React.ComponentProps<'div'>) {\n  const { viewportRef, scrollToBottom } = useChatContext()\n\n  React.useLayoutEffect(() => {\n    scrollToBottom('instant')\n  }, [scrollToBottom])\n\n  return (\n    <div\n      ref={viewportRef}\n      className={cn(\n        'bg-card border-border flex flex-col overflow-y-auto rounded-xl border px-4',\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\n/* -------------------------------------------------------------------------------------------------\n * ChatMessages\n * -------------------------------------------------------------------------------------------------*/\n\nexport function ChatMessages({\n  className,\n  ...props\n}: React.ComponentProps<'div'>) {\n  const { onViewportHeightChange } = useChatContext()\n\n  const [ref, { height }] = useMeasure()\n\n  React.useEffect(() => {\n    onViewportHeightChange(height)\n  }, [height, onViewportHeightChange])\n\n  return <div ref={ref} className={cn('h-max', className)} {...props} />\n}\n\n/* -------------------------------------------------------------------------------------------------\n * ChatMessage\n * -------------------------------------------------------------------------------------------------*/\n\ntype ChatMessageProps = React.ComponentProps<'div'> & {\n  variant?: ChatMessageVariant\n}\n\nexport function ChatMessageRow({\n  className,\n  variant = 'self',\n  ...props\n}: ChatMessageProps) {\n  return (\n    <div\n      data-variant={variant}\n      className={cn(\n        'group/message-row my-4 grid items-center',\n        variant === 'self'\n          ? 'grid-cols-[1fr_auto_auto] justify-items-end [grid-template-areas:\"addon-inline_message_avatar\"\"addon-block_addon-block_none\"]'\n          : 'grid-cols-[auto_auto_1fr] justify-items-start [grid-template-areas:\"avatar_message_addon-inline\"\"none_addon-block_addon-block\"]',\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\n/* -------------------------------------------------------------------------------------------------\n * ChatMessageAvatar\n * -------------------------------------------------------------------------------------------------*/\n\ntype ChatMessageAvatarProps = React.ComponentProps<typeof Avatar> & {\n  src?: string\n  alt?: string\n  fallback?: React.ReactNode\n}\n\nexport function ChatMessageAvatar({\n  className,\n  src,\n  alt,\n  fallback,\n  children,\n  ...props\n}: ChatMessageAvatarProps) {\n  return (\n    <Avatar\n      className={cn(\n        'size-8 shrink-0 self-end [grid-area:avatar] group-not-data-[variant=self]/message-row:mr-2 group-data-[variant=self]/message-row:ml-2',\n        className\n      )}\n      title={alt}\n      {...props}\n    >\n      {src && <AvatarImage src={src} alt={alt} />}\n      <AvatarFallback>{fallback ?? children}</AvatarFallback>\n    </Avatar>\n  )\n}\n\n/* -------------------------------------------------------------------------------------------------\n * ChatMessageBubble\n * -------------------------------------------------------------------------------------------------*/\n\ntype ChatMessageBubbleProps = React.ComponentProps<'div'>\n\nexport function ChatMessageBubble({\n  className,\n  ...props\n}: ChatMessageBubbleProps) {\n  return (\n    <div\n      className={cn(\n        'w-fit max-w-96 min-w-0 rounded-xl text-sm wrap-break-word whitespace-pre-wrap [grid-area:message] group-not-data-[variant=system]/message-row:px-4 group-not-data-[variant=system]/message-row:py-2',\n        /* Self */\n        'group-data-[variant=self]/message-row:bg-primary group-data-[variant=self]/message-row:text-primary-foreground',\n        /* Peer */\n        'group-data-[variant=peer]/message-row:bg-primary/10 group-data-[variant=peer]/message-row:text-foreground',\n        /* System */\n        'group-data-[variant=system]/message-row:text-muted-foreground group-data-[variant=system]/message-row:px-1',\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\n/* -------------------------------------------------------------------------------------------------\n * ChatMessageAddon\n * -------------------------------------------------------------------------------------------------*/\ntype ChatMessageAddonProps = React.ComponentProps<'div'> & {\n  align?: 'inline' | 'block'\n}\n\nexport function ChatMessageAddon({\n  className,\n  align = 'block',\n  ...props\n}: ChatMessageAddonProps) {\n  return (\n    <div\n      data-slot=\"chat-message-addon\"\n      data-align={align}\n      className={cn(\n        'flex items-center gap-2',\n        align === 'inline'\n          ? '[grid-area:addon-inline] group-not-data-[variant=self]/message-row:ml-2 group-data-[variant=self]/message-row:mr-2'\n          : 'mt-2 [grid-area:addon-block]',\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\n/* -------------------------------------------------------------------------------------------------\n * ChatMessageTime\n * -------------------------------------------------------------------------------------------------*/\n\nexport function ChatMessageTime({\n  className,\n  dateTime,\n  children,\n  ...props\n}: Omit<React.ComponentProps<'time'>, 'dateTime'> & { dateTime: Date }) {\n  return (\n    <time\n      className={cn(\n        'text-muted-foreground text-xs',\n        /* Only place it at addon-block position if it's not being wrapped by an addon already */\n        '[&:not([data-slot=\"chat-message-addon\"]_*)]:mt-2 [&:not([data-slot=\"chat-message-addon\"]_*)]:[grid-area:addon-block]',\n        className\n      )}\n      dateTime={dateTime.toISOString()}\n      {...props}\n    >\n      {children ??\n        dateTime.toLocaleTimeString([], {\n          hour: '2-digit',\n          minute: '2-digit',\n        })}\n    </time>\n  )\n}\n\n/* -------------------------------------------------------------------------------------------------\n * ChatInputArea\n * -------------------------------------------------------------------------------------------------*/\n\ntype ChatInputAreaProps = Omit<\n  React.ComponentProps<'form'>,\n  'children' | 'onSubmit'\n> &\n  Pick<React.ComponentProps<typeof InputGroup>, 'children'>\n\nexport function ChatInputArea({\n  className,\n  children,\n  ...props\n}: ChatInputAreaProps) {\n  const {\n    onSubmit: onSubmitContext,\n    inputRef,\n    scrollToBottom,\n    onInputHeightChange,\n  } = useChatContext()\n  const [areaRef, { height }] = useMeasure()\n\n  const handleSubmit = (e: React.FormEvent<HTMLFormElement>) => {\n    e.preventDefault()\n\n    const form = e.currentTarget\n    const input = inputRef.current\n    const message = input?.value.trim()\n\n    if (!message || !input) return\n\n    const event = new ChatSubmitEvent({\n      form,\n      input,\n      message,\n    })\n\n    onSubmitContext?.(event)\n\n    if (!event.defaultPrevented) {\n      form.reset()\n    }\n\n    requestAnimationFrame(() => {\n      scrollToBottom('smooth')\n    })\n  }\n\n  React.useEffect(() => {\n    onInputHeightChange(height)\n  }, [height, onInputHeightChange])\n\n  return (\n    <form className=\"contents\" onSubmit={handleSubmit} {...props}>\n      <InputGroup\n        className={cn(\n          'h-auto items-end rounded-3xl text-base leading-normal md:text-sm',\n          '**:data-[slot=input-group-control]:py-3 **:data-[slot=input-group-control]:pl-6 **:data-[slot=input-group-control]:[font-size:inherit] **:data-[slot=input-group-control]:leading-[inherit]',\n          '**:data-[slot=mention]:contents **:data-[slot=mention]:[&>div]:min-w-0 **:data-[slot=mention]:[&>div]:flex-1',\n          '[--input-area-height:calc(--spacing(6)+var(--leading-normal)*1em)]',\n          className\n        )}\n        ref={areaRef}\n      >\n        {children}\n      </InputGroup>\n    </form>\n  )\n}\n\nfunction ChatMultilineInput({\n  ref,\n  ...props\n}: React.ComponentProps<typeof InputGroupTextarea>) {\n  const textareaRef = React.useRef<HTMLTextAreaElement>(null)\n  const composedRef = useComposedRefs<HTMLTextAreaElement>(ref, textareaRef)\n\n  React.useEffect(() => {\n    const textarea = textareaRef.current\n    if (!textarea) return\n\n    const supportsFieldSizing = CSS.supports('field-sizing', 'content')\n\n    const handleInput = () => {\n      if (!supportsFieldSizing) {\n        textarea.style.height = '0'\n        textarea.style.height = `${textarea.scrollHeight}px`\n      }\n\n      textarea.scrollTop = textarea.scrollHeight\n    }\n\n    handleInput()\n\n    textarea.addEventListener('input', handleInput)\n\n    return () => {\n      textarea.removeEventListener('input', handleInput)\n    }\n  }, [])\n\n  return <InputGroupTextarea name=\"message\" {...props} ref={composedRef} />\n}\n\nfunction ChatSinglelineInput({\n  ...props\n}: React.ComponentProps<typeof InputGroupInput>) {\n  return <InputGroupInput name=\"message\" {...props} />\n}\n\ntype TextareaProps = Omit<\n  React.ComponentProps<typeof InputGroupTextarea>,\n  'multiline'\n>\ntype InputProps = Omit<\n  React.ComponentProps<typeof InputGroupInput>,\n  'multiline'\n>\n\ntype ChatInputProps =\n  | ({ multiline: true } & TextareaProps)\n  | ({ multiline: false } & InputProps)\n\nexport function ChatInputField({ ref, ...rest }: ChatInputProps) {\n  const { inputRef } = useChatContext()\n  const composedRef = useComposedRefs<HTMLInputElement | HTMLTextAreaElement>(\n    ref,\n    inputRef\n  )\n\n  const submitOnEnter = (\n    e: React.KeyboardEvent<HTMLInputElement | HTMLTextAreaElement>\n  ) => {\n    if (e.key === 'Enter' && !e.shiftKey && !e.defaultPrevented) {\n      e.preventDefault()\n      e.currentTarget.form?.requestSubmit()\n    }\n  }\n\n  if (rest.multiline) {\n    const { className, onKeyDown, multiline: _, ..._rest } = rest\n\n    return (\n      <>\n        <style>{\n          /* css */ `\n            @layer utilities {\n              .safe-field-sizing-content {\n                height: 0;\n              }\n\n              @supports (field-sizing: content) {\n                .safe-field-sizing-content {\n                  field-sizing: content;\n                  height: auto;\n                }\n              }\n            }\n          `\n        }</style>\n        <ChatMultilineInput\n          className={cn(\n            'safe-field-sizing-content max-h-32 min-h-(--input-area-height)',\n            className\n          )}\n          onKeyDown={(e) => {\n            onKeyDown?.(e)\n            submitOnEnter(e)\n          }}\n          {..._rest}\n          ref={composedRef}\n        />\n      </>\n    )\n  }\n\n  const { className, onKeyDown, multiline: _, ..._rest } = rest\n\n  return (\n    <ChatSinglelineInput\n      className={cn('h-(--input-area-height)', className)}\n      onKeyDown={(e) => {\n        onKeyDown?.(e)\n        submitOnEnter(e)\n      }}\n      {..._rest}\n      ref={composedRef}\n    />\n  )\n}\n\nexport function ChatInputSubmit({\n  className,\n  disabled,\n  children,\n  ...props\n}: React.ComponentProps<typeof InputGroupButton>) {\n  return (\n    <InputGroupAddon\n      align=\"inline-end\"\n      className={cn('[font-size:inherit] **:[font-size:inherit]', className)}\n    >\n      <InputGroupButton\n        variant=\"default\"\n        type=\"submit\"\n        className=\"size-[calc(var(--leading-normal)*1em+var(--spacing)*3)] rounded-full\"\n        size=\"icon-sm\"\n        disabled={disabled}\n        {...props}\n      >\n        {children ?? (\n          <>\n            <ArrowUpIcon className=\"size-[1.2em]\" />\n            <span className=\"sr-only\">Send</span>\n          </>\n        )}\n      </InputGroupButton>\n    </InputGroupAddon>\n  )\n}\n",
      "type": "registry:component"
    },
    {
      "path": "hooks/use-interruption.ts",
      "content": "import * as React from 'react'\n\n/**\n * Hook to manage user interruption state with a timeout-based cooldown.\n * When `interrupt` is called, sets a flag for a duration that can be checked via `isInterruptedRef`.\n */\nexport const useUserInterruption = (duration: number = 200) => {\n  const interruptedRef = React.useRef(false)\n  const timeoutRef = React.useRef<ReturnType<typeof setTimeout> | null>(null)\n\n  const interrupt = React.useCallback(() => {\n    interruptedRef.current = true\n\n    if (timeoutRef.current) {\n      clearTimeout(timeoutRef.current)\n    }\n\n    timeoutRef.current = setTimeout(() => {\n      interruptedRef.current = false\n      timeoutRef.current = null\n    }, duration)\n  }, [duration])\n\n  React.useEffect(() => {\n    return () => {\n      if (timeoutRef.current) {\n        clearTimeout(timeoutRef.current)\n      }\n    }\n  }, [])\n\n  return { interruptedRef, interrupt }\n}\n",
      "type": "registry:hook"
    }
  ]
}